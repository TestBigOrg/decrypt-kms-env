#!/usr/bin/env bash

set -euo pipefail

if ! which aws > /dev/null; then
  echo "Could not find required command 'aws'"
  exit 1
fi

for pair in $(env | grep '=secure:'); do
    key=${pair%=*}
    encrypted=${pair#*=secure:}
    echo $encrypted | base64 -d > /tmp/kms-encrypted-value
    decrypted=$(aws kms decrypt --ciphertext-blob fileb:///tmp/kms-encrypted-value --query 'Plaintext' --output text | base64 -d)
    export $key="$decrypted"
    rm -f /tmp/kms-encrypted-value
done

