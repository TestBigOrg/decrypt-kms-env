#!/usr/bin/env sh

set -eu

if ! type aws > /dev/null; then
    echo "Could not find required command 'aws'"
    exit 1
fi

for pair in $(env | grep '=secure:'); do
    key=${pair%=secure:*}
    encrypted=${pair#*=secure:}
    echo $encrypted | base64 -d > ./kms-encrypted-value
    decrypted=$(aws kms decrypt --ciphertext-blob fileb://./kms-encrypted-value --query 'Plaintext' --output text | base64 -d)
    export $key="$decrypted"
    echo "Decrypted $key=$(echo -n "${decrypted}" | cut -b 4- | sed 's,.,*,g')$(echo -n "${decrypted}" | tail -c -4)"
    rm -f ./kms-encrypted-value
done

